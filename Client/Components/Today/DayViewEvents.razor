@using Client.Enums
@using Client.Models

<div class="day-view-events 
            @GetEventTypeClass() 
            @GetSelectedClass() 
            @GetCompletedClass()" 
            @onclick="HandleEventClick">
            
    <div class="day-view-event-content">
        @* Display icon for the primary event type *@
        @if (EventType != null)
        {
            <i class="bi @IconForEventType(EventType.Value) day-view-event-icon"></i>
        }
        
        @* Display truncated title *@
        <span class="day-view-event-description">@TruncateTitle(Title)</span>
        
        @if (IsCompleted)
        {
            <button type="button" class="btn btn-sm btn-link day-view-event-undo-button p-0" 
                    @onclick="HandleUndoClick" @onclick:stopPropagation="true"
                    title="Undo">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
        }
        else
        {
            <div class="form-check" @onclick:stopPropagation="true">
                <input type="checkbox" class="form-check-input" 
                       checked="@IsSelected"
                       @onchange="HandleCheckboxChange" />
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public EventTypeEnums? EventType { get; set; }
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string Description { get; set; } = string.Empty;
    [Parameter] public int MaxTitleLength { get; set; } = 100;
    [Parameter] public bool CanBePostponed { get; set; } = true;
    [Parameter] public EventCallback<bool> CheckboxSelected { get; set; }
    [Parameter] public bool IsSelected { get; set; }
    [Parameter] public EventCallback OnEventClick { get; set; }
    [Parameter] public bool IsActive { get; set; }
    [Parameter] public bool IsCompleted { get; set; } = false;
    [Parameter] public EventCallback OnUndo { get; set; }
    
    public string TruncateTitle(string title)
    {
        if (string.IsNullOrEmpty(title))
        {
            return string.Empty;
        }
        
        if (title.Length > MaxTitleLength)
        {
            return title.Substring(0, MaxTitleLength) + "...";
        }
        return title;
    }

    public string IconForEventType(EventTypeEnums eventType)
    {
        return eventType switch
        {
            EventTypeEnums.InternalMeeting => "bi-door-open",
            EventTypeEnums.ExternalMeeting => "bi-building",
            EventTypeEnums.WebDemo => "bi-camera-video",
            EventTypeEnums.HomeConference => "bi-house",
            EventTypeEnums.AwayConference => "bi-airplane",
            EventTypeEnums.SchoolVisit => "bi-mortarboard",
            _ => "bi-calendar-event"
        };
    }

    public string GetEventTypeClass()
    {
        if (EventType == null)
        {
            return "day-view-event-other";
        }

        return EventType.Value switch
        {
            EventTypeEnums.InternalMeeting => "day-view-event-internal-meeting",
            EventTypeEnums.ExternalMeeting => "day-view-event-external-meeting",
            EventTypeEnums.WebDemo => "day-view-event-web-demo",
            EventTypeEnums.HomeConference => "day-view-event-home-conference",
            EventTypeEnums.AwayConference => "day-view-event-away-conference",
            EventTypeEnums.SchoolVisit => "day-view-event-school-visit",
            _ => "day-view-event-other"
        };
    }

    private string GetSelectedClass()
    {
        return IsActive ? "day-view-event-active" : string.Empty;
    }

    private string GetCompletedClass()
    {
        return IsCompleted ? "day-view-event-completed" : string.Empty;
    }

    private async Task HandleEventClick()
    {
        await OnEventClick.InvokeAsync();
    }

    private async Task HandleUndoClick()
    {
        await OnUndo.InvokeAsync();
    }

    private async Task HandleCheckboxChange(ChangeEventArgs e)
    {
        var isChecked = (bool)(e.Value ?? false);
        await CheckboxSelected.InvokeAsync(isChecked);
    }
}
