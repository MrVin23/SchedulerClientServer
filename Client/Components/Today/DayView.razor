@using Client.Enums
@using Client.Components.Today
@using Client.Models
@using System.Linq
@* Purpose of this component is to display a day view in a large div it works outside of the calendar view *@
@if (formErrors.Any())
{
    <div class="alert alert-danger mb-3">
        <strong>Please fix the following errors (@formErrors.Length):</strong>
        <ul class="mb-0 mt-2">
            @foreach (var error in formErrors)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}

<div class="day-view-wrapper">
    <div class="day-view-container" style="min-height: @MinimumHeight; max-height: @MaximumHeight; min-width: @MinimumWidth; max-width: @MaximumWidth;">
    @* Display day and date with navigation *@
    <div class="day-view-header"> 
        <div class="day-view-header-top">
            <button class="btn btn-outline-light btn-sm day-view-nav-button" @onclick="NavigateToPreviousDay" title="Previous day">
                <i class="bi bi-chevron-left"></i>
            </button>
            
            <div class="day-view-header-info">
                <div class="day-view-date text-white">@DisplayDate</div>
            </div>
            
            @if (IsNotToday)
            {
                <button class="btn btn-outline-light btn-sm" @onclick="NavigateToToday" title="Go to today">
                    <i class="bi bi-calendar-check"></i>
                </button>
            }
            
            <button class="btn btn-outline-light btn-sm day-view-nav-button" @onclick="NavigateToNextDay" title="Next day">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        
        <div class="day-view-header-actions">
            <div class="btn-group day-view-button-group" role="group">
                <button class="btn btn-outline-light btn-sm" @onclick="HandleBulkComplete" disabled="@(!_hasSelectedEvents)" title="Complete">
                    <i class="bi bi-check-circle"></i>
                </button>
                
                <button class="btn btn-outline-light btn-sm" @onclick="HandleBulkPostpone" disabled="@(!_hasSelectedEvents)" title="Postpone to tomorrow">
                    <i class="bi bi-arrow-right-circle"></i>
                </button>
                
                <button class="btn btn-outline-light btn-sm" @onclick="HandleBulkFollowUp" disabled="@(!_hasSelectedEvents)" title="Follow Up">
                    <i class="bi bi-arrow-up-circle"></i>
                </button>
                
                <button class="btn btn-outline-light btn-sm" @onclick="HandleBulkReject" disabled="@(!_hasSelectedEvents)" title="Reject">
                    <i class="bi bi-trash"></i>
                </button>
                
                <button class="btn btn-outline-light btn-sm" @onclick="HandleAddEventClick" title="Add Event">
                    <i class="bi bi-plus-circle"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="day-view-content">
        @if (Events != null && Events.Any())
        {
            @* Uncompleted events at the top *@
            <div class="day-view-events-top">
                @foreach (var evt in GetUncompletedEvents())
                {
                    <DayViewEvents @key="evt.Id"
                                   EventType="@((Client.Enums.EventTypeEnums?)evt.EventType)" 
                                   Title="@evt.Title"
                                   Description="@evt.Description" 
                                   CanBePostponed="@evt.CanBePostponed"
                                   IsSelected="@evt.IsSelected"
                                   IsCompleted="@evt.IsCompleted"
                                   IsActive="@(SelectedEvent == evt)"
                                   CheckboxSelected="EventCallback.Factory.Create<bool>(this, (bool isSelected) => HandlePostponedChanged(evt, isSelected))"
                                   OnEventClick="@(() => HandleEventClick(evt))"
                                   OnUndo="@(() => HandleUndo(evt))" />
                }
            </div>
            
            @* Spacer to push completed events to bottom *@
            <div class="day-view-events-spacer"></div>
            
            @* Completed events at the bottom *@
            <div class="day-view-events-bottom">
                @foreach (var evt in GetCompletedEvents())
                {
                    <DayViewEvents @key="evt.Id"
                                   EventType="@((Client.Enums.EventTypeEnums?)evt.EventType)" 
                                   Title="@evt.Title"
                                   Description="@evt.Description" 
                                   CanBePostponed="@evt.CanBePostponed"
                                   IsSelected="@evt.IsSelected"
                                   IsCompleted="@evt.IsCompleted"
                                   IsActive="@(SelectedEvent == evt)"
                                   CheckboxSelected="EventCallback.Factory.Create<bool>(this, (bool isSelected) => HandlePostponedChanged(evt, isSelected))"
                                   OnEventClick="@(() => HandleEventClick(evt))"
                                   OnUndo="@(() => HandleUndo(evt))" />
                }
            </div>
        }
        else
        {
            <div class="day-view-no-events">No events scheduled for this day</div>
        }
    </div>
    </div>
    
    @if (SelectedEvent != null || CurrentMode == PageMode.Create)
    {
        <div class="event-description-with-actions">
            <EventDescription Title="@GetEventTitle()"
                               Description="@GetEventDescription()"
                               StartDateTime="@GetEventStartDateTime()"
                               EndDateTime="@GetEventEndDateTime()"
                               StartDateTimeChanged="HandleStartDateTimeChanged"
                               EndDateTimeChanged="HandleEndDateTimeChanged"
                               EventType="@GetEventType()"
                               CanBePostponed="@GetEventCanBePostponed()"
                               TitleChanged="HandleTitleChanged"
                               DescriptionChanged="HandleDescriptionChanged"
                               EventTypeChanged="HandleEventTypeChanged"
                               CanBePostponedChanged="HandleCanBePostponedChanged"
                               MinimumHeight="@MinimumHeight"
                               MaximumHeight="@MaximumHeight"
                               DateTimeWidth="@DateTimeWidth"
                               Mode="@CurrentMode"
                               OnModeChanged="HandleModeChanged" />
            @if (CurrentMode == PageMode.Create || CurrentMode == PageMode.Edit)
            {
                <div class="event-actions-vertical">
                    <button class="btn btn-success event-action-button" @onclick="HandleSave" title="Save">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn btn-danger event-action-button" @onclick="HandleCancel" title="Cancel">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            }
        </div>
    }
</div>
