@using Client.Enums
@* Serves as a div to view edit and create a new event and description *@
<div class="event-description-container card" style="@GetContainerStyle()">
    <div class="card-header event-description-header d-flex align-items-center justify-content-between">
        @if (Mode == PageMode.Read)
        {
            <h5 class="event-description-title mb-0">@Title</h5>
        }
        else
        {
            <input type="text" class="form-control event-description-title-input" 
                   value="@Title"
                   @oninput="HandleTitleInput"
                   placeholder="Title"
                   required />
        }
        @if (Mode == PageMode.Read)
        {
            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="HandleEditClick" title="Edit">
                <i class="bi bi-pencil"></i>
            </button>
        }
    </div>
    
    <div class="card-body event-description-content">
        <div class="event-description-section mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control"
                      rows="4"
                      value="@Description"
                      @oninput="HandleDescriptionInput"
                      readonly="@(Mode == PageMode.Read)"
                      placeholder="Description"></textarea>
        </div>
        
        <div class="event-description-section mb-3">
            <div class="row g-2" style="@GetDateTimeRowStyle()">
                <div class="col-md-4">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control"
                           value="@GetDisplayDateValue()"
                           @onchange="HandleDateChange"
                           min="@DateTime.Today.ToString("yyyy-MM-dd")"
                           disabled="@(Mode == PageMode.Read)" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Start Time</label>
                    <input type="time" class="form-control"
                           value="@GetStartTimeValue()"
                           @onchange="HandleStartTimeChange"
                           disabled="@(Mode == PageMode.Read)"
                           required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">End Time</label>
                    <input type="time" class="form-control"
                           value="@GetEndTimeValue()"
                           @onchange="HandleEndTimeChange"
                           disabled="@(Mode == PageMode.Read)"
                           required />
                </div>
            </div>
        </div>
        
        <div class="event-description-section">
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Event Type</label>
                    <select class="form-select"
                            value="@GetEventTypeValue()"
                            @onchange="HandleEventTypeChange"
                            disabled="@(Mode == PageMode.Read)">
                        @foreach (var eventType in GetAllEventTypes())
                        {
                            <option value="@((int?)eventType)">
                                @(eventType.HasValue ? GetEventTypeName(eventType.Value) : "Not specified")
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" 
                               id="canBePostponed"
                               checked="@CanBePostponed"
                               @onchange="HandleCanBePostponedChange"
                               disabled="@(Mode == PageMode.Read)">
                        <label class="form-check-label" for="canBePostponed">
                            Can be postponed
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string Description { get; set; } = string.Empty;
    [Parameter] public DateTime? StartDateTime { get; set; }
    [Parameter] public DateTime? EndDateTime { get; set; }
    [Parameter] public EventTypeEnums? EventType { get; set; }
    [Parameter] public bool CanBePostponed { get; set; } = true;
    [Parameter] public string MinimumHeight { get; set; } = string.Empty;
    [Parameter] public string MaximumHeight { get; set; } = string.Empty;
    [Parameter] public string DateTimeWidth { get; set; } = string.Empty;
    [Parameter] public PageMode Mode { get; set; } = PageMode.Read;
    [Parameter] public EventCallback OnEdit { get; set; }
    [Parameter] public EventCallback<PageMode> OnModeChanged { get; set; }
    [Parameter] public EventCallback<DateTime?> StartDateTimeChanged { get; set; }
    [Parameter] public EventCallback<DateTime?> EndDateTimeChanged { get; set; }
    [Parameter] public EventCallback<string> TitleChanged { get; set; }
    [Parameter] public EventCallback<string> DescriptionChanged { get; set; }
    [Parameter] public EventCallback<EventTypeEnums?> EventTypeChanged { get; set; }
    [Parameter] public EventCallback<bool> CanBePostponedChanged { get; set; }

    private async Task HandleEditClick()
    {
        await OnModeChanged.InvokeAsync(PageMode.Edit);
    }

    private string GetDisplayDateValue()
    {
        return StartDateTime?.ToString("yyyy-MM-dd") ?? "";
    }

    private string GetStartTimeValue()
    {
        return StartDateTime?.ToString("HH:mm") ?? "";
    }

    private string GetEndTimeValue()
    {
        return EndDateTime?.ToString("HH:mm") ?? "";
    }

    private string GetEventTypeValue()
    {
        return EventType.HasValue ? ((int)EventType.Value).ToString() : "";
    }

    private async Task HandleTitleInput(ChangeEventArgs e)
    {
        Title = e.Value?.ToString() ?? "";
        await TitleChanged.InvokeAsync(Title);
    }

    private async Task HandleDescriptionInput(ChangeEventArgs e)
    {
        Description = e.Value?.ToString() ?? "";
        await DescriptionChanged.InvokeAsync(Description);
    }

    private async Task HandleDateChange(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var newDate))
        {
            var startTimeOfDay = StartDateTime?.TimeOfDay ?? TimeSpan.FromHours(9);
            StartDateTime = newDate.Date + startTimeOfDay;
            EndDateTime = StartDateTime?.AddMinutes(30);

            await StartDateTimeChanged.InvokeAsync(StartDateTime);
            await EndDateTimeChanged.InvokeAsync(EndDateTime);
        }
    }

    private async Task HandleStartTimeChange(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e.Value?.ToString(), out var newTime))
        {
            var date = StartDateTime?.Date ?? DateTime.Today;
            StartDateTime = date + newTime;
            EndDateTime = StartDateTime?.AddMinutes(30);

            await StartDateTimeChanged.InvokeAsync(StartDateTime);
            await EndDateTimeChanged.InvokeAsync(EndDateTime);
        }
    }

    private async Task HandleEndTimeChange(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e.Value?.ToString(), out var newTime))
        {
            var date = EndDateTime?.Date ?? StartDateTime?.Date ?? DateTime.Today;
            EndDateTime = date + newTime;
            await EndDateTimeChanged.InvokeAsync(EndDateTime);
        }
    }

    private async Task HandleEventTypeChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var typeId))
        {
            EventType = (EventTypeEnums)typeId;
        }
        else
        {
            EventType = null;
        }
        await EventTypeChanged.InvokeAsync(EventType);
    }

    private async Task HandleCanBePostponedChange(ChangeEventArgs e)
    {
        CanBePostponed = (bool)(e.Value ?? false);
        await CanBePostponedChanged.InvokeAsync(CanBePostponed);
    }

    private string GetContainerStyle()
    {
        var styles = new List<string>();
        if (!string.IsNullOrEmpty(MinimumHeight))
        {
            styles.Add($"min-height: {MinimumHeight}");
        }
        if (!string.IsNullOrEmpty(MaximumHeight))
        {
            styles.Add($"max-height: {MaximumHeight}");
        }
        return string.Join("; ", styles);
    }

    private string GetDateTimeRowStyle()
    {
        if (!string.IsNullOrEmpty(DateTimeWidth))
        {
            return $"max-width: {DateTimeWidth};";
        }
        return string.Empty;
    }

    public string IconForEventType(EventTypeEnums eventType)
    {
        return eventType switch
        {
            EventTypeEnums.InternalMeeting => "bi-door-open",
            EventTypeEnums.ExternalMeeting => "bi-building",
            EventTypeEnums.WebDemo => "bi-camera-video",
            EventTypeEnums.HomeConference => "bi-house",
            EventTypeEnums.AwayConference => "bi-airplane",
            EventTypeEnums.SchoolVisit => "bi-mortarboard",
            _ => "bi-calendar-event"
        };
    }

    public string GetEventTypeName(EventTypeEnums eventType)
    {
        return eventType switch
        {
            EventTypeEnums.InternalMeeting => "Internal Meeting",
            EventTypeEnums.ExternalMeeting => "External Meeting",
            EventTypeEnums.WebDemo => "Web Demo",
            EventTypeEnums.HomeConference => "Home Conference",
            EventTypeEnums.AwayConference => "Away Conference",
            EventTypeEnums.SchoolVisit => "School Visit",
            _ => "Other"
        };
    }

    private IEnumerable<EventTypeEnums?> GetAllEventTypes()
    {
        return Enum.GetValues<EventTypeEnums>().Select(e => (EventTypeEnums?)e);
    }
}
