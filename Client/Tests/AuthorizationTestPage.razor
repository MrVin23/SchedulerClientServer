@page "/test-authorization"
@layout StoryLayout
@using MudBlazor
@using Microsoft.AspNetCore.Components.WebAssembly.Http

<PageTitle>Authorization Test Page</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @* Header Section *@
    <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Class="mr-2" Style="vertical-align: middle;" />
                    Authorization Test Page
                </MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.8);">
                    This page has NO authorization restrictions. Test if server endpoints properly enforce security.
                </MudText>
            </MudStack>
            <MudChip T="string" Color="Color.Warning" Variant="Variant.Filled">No Auth Required</MudChip>
        </MudStack>
    </MudPaper>

    @* Info Alert *@
    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4" Dense="true">
        <MudText Typo="Typo.body2">
            <strong>Purpose:</strong> This page allows you to test authorization endpoints without being logged in. 
            Successful access when not authenticated indicates a security issue. Expected behavior: 401 (Unauthorized) or 403 (Forbidden).
        </MudText>
    </MudAlert>

    <MudGrid Spacing="3">
        @* Authentication Status Card *@
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; border-radius: 8px;">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" Style="vertical-align: middle;" Color="Color.Primary" />
                        Authentication Status
                    </MudText>
                    <MudDivider />
                    
                    @if (_isCheckingAuth)
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="py-4">
                            <MudProgressCircular Indeterminate="true" Size="Size.Medium" Color="Color.Primary" />
                            <MudText Typo="Typo.caption">Checking authentication...</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Status:</MudText>
                                @if (_isAuthenticated)
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Authenticated</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">Not Authenticated</MudChip>
                                }
                            </MudStack>
                            
                            @if (_isAuthenticated)
                            {
                                <MudText Typo="Typo.body2"><strong>User:</strong> @_username</MudText>
                                <MudText Typo="Typo.body2"><strong>Email:</strong> @_email</MudText>
                                <MudText Typo="Typo.body2"><strong>User ID:</strong> @_userId</MudText>
                            }
                        </MudStack>
                    }
                    
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Primary" 
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="CheckAuthenticationStatus"
                               Disabled="_isCheckingAuth">
                        Refresh Status
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Quick Actions Card *@
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; border-radius: 8px;">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Class="mr-2" Style="vertical-align: middle;" Color="Color.Secondary" />
                        Quick Actions
                    </MudText>
                    <MudDivider />
                    
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.PlayCircle"
                                       OnClick="RunAllTests"
                                       Disabled="_isRunningAllTests">
                                @if (_isRunningAllTests)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Running...</span>
                                }
                                else
                                {
                                    <span>Run All Tests</span>
                                }
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Warning" 
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.ClearAll"
                                       OnClick="ClearResults">
                                Clear Results
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Info" 
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Login"
                                       OnClick="@(() => Navigation.NavigateTo("/login"))">
                                Go to Login
                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    @if (_testResults.Any())
                    {
                        <MudDivider Class="my-2" />
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">
                                <strong>Summary:</strong> 
                                <MudChip T="string" Color="Color.Success" Size="Size.Small" Class="mx-1">@_testResults.Count(r => r.Success) Passed</MudChip>
                                <MudChip T="string" Color="Color.Error" Size="Size.Small" Class="mx-1">@_testResults.Count(r => !r.Success) Failed</MudChip>
                            </MudText>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Policy-Based Endpoints Card *@
        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 8px;">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Policy" Class="mr-2" Style="vertical-align: middle;" Color="Color.Error" />
                        Policy-Based Endpoints
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        These endpoints require specific permissions assigned to roles
                    </MudText>
                    <MudDivider />
                    
                    @foreach (var endpoint in _policyEndpoints)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="py-1">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2"><strong>@endpoint.Name</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@endpoint.Description</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                @if (endpoint.Result.HasValue)
                                {
                                    <MudChip T="string" 
                                             Color="@(endpoint.Result.Value ? Color.Success : Color.Error)" 
                                             Size="Size.Small"
                                             Variant="Variant.Filled">
                                        @(endpoint.Result.Value ? "✓ Access" : $"✗ {endpoint.StatusCode}")
                                    </MudChip>
                                }
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           OnClick="@(() => TestEndpoint(endpoint))"
                                           Disabled="endpoint.IsTesting">
                                    @if (endpoint.IsTesting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    }
                                    else
                                    {
                                        <span>Test</span>
                                    }
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Permission Endpoints Card *@
        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 8px;">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Key" Class="mr-2" Style="vertical-align: middle;" Color="Color.Warning" />
                        Direct Permission Tests
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Test specific permissions via dynamic endpoint
                    </MudText>
                    <MudDivider />
                    
                    @foreach (var endpoint in _permissionEndpoints)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="py-1">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2"><strong>@endpoint.Name</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@endpoint.Description</MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                @if (endpoint.Result.HasValue)
                                {
                                    <MudChip T="string" 
                                             Color="@(endpoint.Result.Value ? Color.Success : Color.Error)" 
                                             Size="Size.Small"
                                             Variant="Variant.Filled">
                                        @(endpoint.Result.Value ? "✓ Has Permission" : $"✗ {endpoint.StatusCode}")
                                    </MudChip>
                                }
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           OnClick="@(() => TestEndpoint(endpoint))"
                                           Disabled="endpoint.IsTesting">
                                    @if (endpoint.IsTesting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    }
                                    else
                                    {
                                        <span>Test</span>
                                    }
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Custom Endpoint Test *@
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 8px;">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Api" Class="mr-2" Style="vertical-align: middle;" Color="Color.Info" />
                        Custom Endpoint Test
                    </MudText>
                    <MudDivider />
                    
                    <MudGrid Spacing="2" AlignItems="AlignItems.Center">
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_customEndpoint" 
                                          Label="API Endpoint" 
                                          Placeholder="api/test/admin"
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Link" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudSelect @bind-Value="_customMethod" Label="Method" Variant="Variant.Outlined">
                                <MudSelectItem Value="@("GET")">GET</MudSelectItem>
                                <MudSelectItem Value="@("POST")">POST</MudSelectItem>
                                <MudSelectItem Value="@("PUT")">PUT</MudSelectItem>
                                <MudSelectItem Value="@("DELETE")">DELETE</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Send"
                                       OnClick="TestCustomEndpoint"
                                       Disabled="_isTestingCustom || string.IsNullOrWhiteSpace(_customEndpoint)"
                                       Style="height: 56px;">
                                @if (_isTestingCustom)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                }
                                Test Endpoint
                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    @if (_customResult != null)
                    {
                        <MudAlert Severity="@(_customResult.Success ? Severity.Success : Severity.Error)" 
                                  Variant="Variant.Outlined"
                                  Dense="true">
                            <MudText Typo="Typo.body2">
                                <strong>@_customMethod @_customEndpoint</strong> - 
                                Status: @_customResult.StatusCode | 
                                @(_customResult.Success ? "Access Granted" : "Access Denied")
                            </MudText>
                        </MudAlert>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Test Results Table *@
        @if (_testResults.Any())
        {
            <MudItem xs="12">
                <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 8px;">
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.TableChart" Class="mr-2" Style="vertical-align: middle;" Color="Color.Success" />
                            Test Results Log
                        </MudText>
                        <MudDivider />
                        
                        <MudSimpleTable Dense="true" Hover="true" Bordered="true" Striped="true">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Endpoint</th>
                                    <th>Method</th>
                                    <th>Status Code</th>
                                    <th>Result</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var result in _testResults.OrderByDescending(r => r.Timestamp))
                                {
                                    <tr>
                                        <td>@result.Timestamp.ToString("HH:mm:ss")</td>
                                        <td><code>@result.Endpoint</code></td>
                                        <td>@result.Method</td>
                                        <td>
                                            <MudChip T="string" 
                                                     Color="@GetStatusColor(result.StatusCode)" 
                                                     Size="Size.Small"
                                                     Variant="Variant.Filled">
                                                @result.StatusCode
                                            </MudChip>
                                        </td>
                                        <td>
                                            @if (result.Success)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                                            }
                                        </td>
                                        <td>@result.Message</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    </MudStack>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

