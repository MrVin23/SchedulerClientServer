@page "/test-role-access"
@layout StoryLayout
@using Client.Interfaces.Authorisation
@using Client.Interfaces
@using Client.Enums

<PageTitle>Test Role Access</PageTitle>

<div class="container py-4" style="max-width: 800px;">
    <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
            <i class="bi bi-person-badge text-primary fs-1"></i>
            <h4 class="mt-3">Test Role-Based Access</h4>
            <p class="text-muted mb-0">Test authentication and role-based authorization</p>
        </div>
    </div>

    @* Authentication Status Card *@
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h6 class="card-title">
                <i class="bi bi-person-check text-info me-2"></i>
                Authentication Status
            </h6>
            
            @if (_isLoading)
            {
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            }
            else if (_isAuthenticated)
            {
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle me-2"></i>
                    Authenticated as: <strong>@_username</strong>
                </div>
                <div class="row">
                    <div class="col-6"><strong>User ID:</strong> @_userId</div>
                    <div class="col-6"><strong>Email:</strong> @_email</div>
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Not Authenticated
                </div>
                <button class="btn btn-primary" @onclick="NavigateToLogin">
                    <i class="bi bi-box-arrow-in-right me-1"></i>Go to Login
                </button>
            }
        </div>
    </div>

    @* Role Access Tests *@
    @if (_isAuthenticated)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-flask text-secondary me-2"></i>
                    Test Role Access Endpoints
                </h6>
                
                <p class="small text-muted mb-3">
                    Click each button to test if your user has the required role/permission to access the endpoint.
                </p>

                @* Admin Test *@
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-12 col-sm-6">
                                <strong>Administrator Role</strong>
                                <small class="d-block text-muted">Policy: "Admin" | Permission: "Admin"</small>
                            </div>
                            <div class="col-12 col-sm-3">
                                <button class="btn btn-danger btn-sm w-100" @onclick="@(() => TestRoleEndpoint("admin"))" disabled="@_testingAdmin">
                                    @if (_testingAdmin)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    Test Admin
                                </button>
                            </div>
                            <div class="col-12 col-sm-3 text-center">
                                @if (_adminResult != null)
                                {
                                    <span class="badge @(_adminResult.Value ? "bg-success" : "bg-danger")">
                                        @(_adminResult.Value ? "✓ Access" : "✗ Denied")
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @* Viewer Test *@
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-12 col-sm-6">
                                <strong>User Role</strong>
                                <small class="d-block text-muted">Policy: "Viewer" | Permission: "Viewer"</small>
                            </div>
                            <div class="col-12 col-sm-3">
                                <button class="btn btn-info btn-sm w-100" @onclick="@(() => TestRoleEndpoint("viewer"))" disabled="@_testingViewer">
                                    @if (_testingViewer)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    Test Viewer
                                </button>
                            </div>
                            <div class="col-12 col-sm-3 text-center">
                                @if (_viewerResult != null)
                                {
                                    <span class="badge @(_viewerResult.Value ? "bg-success" : "bg-danger")">
                                        @(_viewerResult.Value ? "✓ Access" : "✗ Denied")
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @* ActiveUser Test *@
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-12 col-sm-6">
                                <strong>VerifiedUser Role</strong>
                                <small class="d-block text-muted">Policy: "ActiveUser" | Permission: "ActiveUser"</small>
                            </div>
                            <div class="col-12 col-sm-3">
                                <button class="btn btn-success btn-sm w-100" @onclick="@(() => TestRoleEndpoint("active-user"))" disabled="@_testingActiveUser">
                                    @if (_testingActiveUser)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    Test Active
                                </button>
                            </div>
                            <div class="col-12 col-sm-3 text-center">
                                @if (_activeUserResult != null)
                                {
                                    <span class="badge @(_activeUserResult.Value ? "bg-success" : "bg-danger")">
                                        @(_activeUserResult.Value ? "✓ Access" : "✗ Denied")
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-outline-primary w-100 mt-3" @onclick="TestAllRoles">
                    <i class="bi bi-play me-1"></i>Test All Roles
                </button>
            </div>
        </div>

        @* Results Summary *@
        @if (_lastTestMessage != null)
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-clipboard-check text-warning me-2"></i>
                        Last Test Result
                    </h6>
                    <div class="alert @GetAlertClass(_lastTestSeverity) mb-0">
                        @_lastTestMessage
                    </div>
                </div>
            </div>
        }
    }
</div>
